<!DOCTYPE html>
<html>
<head lang="en">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <title>米乐熊-商品入库</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="#(basePath)/library/css/bootstrap.css"/>
    <link rel="stylesheet" type="text/css" href="#(basePath)/library/css/sitemain.css"/>
    <script type="text/javascript" src="#(basePath)/library/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="#(basePath)/library/js/bootstrap.js"></script>
    <script type="text/javascript" src="#(basePath)/library/js/jquery-ajaxfileupload.js"></script>
    
    <script>    
    	function uploadBatchFile() {
    		
    		if ($("#batchname").val() == "") {
    			showAlert("错误提示", "批次名不能为空.");
    			$("#batchname").focus();
    			return;
    		}
    		if ($("#batchfile").val() == "") {
    			showAlert("错误提示", "文件名不能为空.");
    			return;
    		}
    		
    		$.ajaxFileUpload({
                url: '#(basePath)/goods/upload?batchname=' + $.trim($("#batchname").val()), //用于文件上传的服务器端请求地址
                secureuri: false, //是否需要安全协议，一般设置为false
                fileElementId: 'batchfile', //文件上传域的ID
        		dataType: 'text',
                success: function (data, status)  //服务器成功响应处理函数
                {                	
                	if (data.match("already-imported")) {
            
                		showAlert("错误提示", "你已经导入本批次，请勿重复导入.");
                		return;
                	}
                	                	
                	$("#batchname").attr("readonly","readonly");
                	$("#batchlist").show();
                	
                    var data = data.replace("<pre>","");
                    data = data.replace("</pre>", "");
                    data = eval(data);
                    
                    if (data.length < 1) {
                    	showAlert("错误提示", "并没有商品信息被导入，请确认.");
                		return;
                	}
                    
                    for (var i=0; i<data.length; i++) {
                    	var batchinfo = "<tr><td>"+ (i+1) +"</td>" + 
                    		"<td>" + data[i].goodsid + "</td>" +
                    		"<td>" + data[i].batchname + "</td>" +
	    					"<td>" + data[i].goodsserial + "</td>" +
	    					"<td>" + data[i].goodsname + "</td>" + 
	    					"<td>" + data[i].quantity + "</td>" +
	    					"<td>" + data[i].unitprice + "</td>" + 
	    					"<td>" + data[i].totalprice + "</td>" +
	    					"<td>" + data[i].costunitprice + "</td>" +
	    					"<td>" + data[i].costtotalprice + "</td></tr>";
	   					$("#batchinfo").append(batchinfo);
                    }
                },
                error: function (data, status, e)//服务器响应失败处理函数
                {
                	showAlert("错误提示", e);
                }
            });
            return false;
    	}
    	
    	function deleteBatch() {
    		if (confirm("你确定要删除本批次信息吗?") != true) {
    			return;
    		}
    		$.post("#(basePath)/goods/delete", "batchname=" + $("#batchname").val(), function(data){
    			if (data == "delete-successful") {
    				location.href = "batch";
    			}
    			else {
    				showAlert("错误提示", "删除失败，请联系管理员确认问题.");
    			}
    		});
    	}
    </script>
</head>
<body>

#include("header.html")

<div class="container" style="background-color: whitesmoke;">
    <div class="row">
        <form class="form-horizontal" role="form">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" style="text-align: center; padding: 30px 10px 0px 10px">
                <span style="font-size: 20px;">请认真检查商品基本信息，确保正确！</span><br>
                <span style="line-height: 60px;">数据导入格式为：第一行为数据字段名称，第二开始为真实数据，列为依次为：货号或编码，商品名称，数量，单价，总金额，折后价，折后总金额。</span>
                <hr style="background-color: #aaaaaa; height: 1px; border: 0px"/>
            </div>
            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4" style="text-align: right; padding: 10px;">
                <label>请输入批次名称：</label>
            </div>
            <div class="col-lg-5 col-md-5 col-sm-5 col-xs-5" style="padding: 10px;">
                <input type="text" id="batchname" value=#(batchName) class="form-control"/>
            </div>

            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4" style="text-align: right; padding: 10px;">
                <label>请输入批次文件：</label>
            </div>
            <div class="col-lg-5 col-md-5 col-sm-5 col-xs-5" style="padding: 10px;">
                <input type="file" id="batchfile" name="batchfile" class="form-control" style="height: 50px;"/>
            </div>
        </form>
        <form class="form-inline">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" style="text-align: center; padding: 30px;">
                <input type="button" class="btn-primary form-control" value="确认导入本批次商品信息" onclick="uploadBatchFile()" style="width: 300px;"/>
            </div>
        </form>
    </div>
    
    <div class="row" id="batchlist" style="display: none;">
    	<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" style="margin: 20px 0;">
    		本批次商品信息导入成功，请确认详情，如需重新导入，请先击“删除本批次商品信息”按钮后，再重新导入。
    	</div>
    	<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
    		<table class="table table-striped">
    			<thead style="font-weight: bold; background-color: #333; color: #eee;">
    				<tr>
    					<td>序号</td>
    					<td>唯一编号</td>
    					<td>批次名称</td>
    					<td>货号/编码</td>
    					<td>商品名称</td>
    					<td>数量</td>
    					<td>单价</td>
    					<td>总金额</td>
    					<td>折后价</td>
    					<td>折后总金额</td>
    				</tr>
    			</thead>
    			<tbody id="batchinfo"></tbody>
    		</table>
    	</div>
    	<form class="form-inline">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" style="text-align: center; padding: 30px;">
                <input type="button" class="btn-primary form-control" value="删除本批次商品信息" onclick="deleteBatch()" style="width: 300px;"/>
            </div>
        </form>
    </div>	
</div>

#include("footer.html")

</body>
</html>